version: "3"

dotenv:
  - .env

env:
  lcov_exclude: >-
    '**/*.g.dart'

tasks:
  setup:
    desc: Enable builds
    cmds:
      - flutter config --enable-linux-desktop --enable-web --enable-android

  generate:
    desc: Generate mocks
    cmds:
      - dart run build_runner build --delete-conflicting-outputs

  .path-coverage-report:
    internal: true
    silent: false
    requires:
      vars: [path]
    vars:
      coverage_file: coverage/lcov.{{ .path }}.info
      coverage_filtered_file: coverage/lcov.{{ .path }}.filtered.info
    cmds:
      - "echo Following files are excluded from coverage: {{ .lcov_exclude }}"
      - lcov --remove {{ .coverage_file }} {{ .lcov_exclude }} -o {{ .coverage_filtered_file }}
      - genhtml {{ .coverage_filtered_file }} -o coverage/html
      - echo "Coverage report generated at file://coverage/html/index.html"

  .path-test:
    internal: true
    silent: true
    requires:
      vars: [path]
    cmds:
      - flutter test --coverage --coverage-path coverage/lcov.{{ .path }}.info test/{{ .path }}
      - task: .path-coverage-report
        vars:
          path: "{{ .path }}"

  test:unit:
    desc: Run only unit tests
    cmds:
      - task: .path-test
        vars: { path: "00_unit" }

  test:widget:
    desc: Run only widget tests
    cmds:
      - task: .path-test
        vars: { path: "01_widget" }

  test:e2e:web:
    preconditions:
      - npx @puppeteer/browsers install chromedriver@stable
    desc: Run e2e tests on web
    cmds:
      - chromedriver --port=4444 &
      - flutter drive
        --driver=test/02_integration/driver.dart
        --target=test/02_integration/server_list_e2e_test.dart
        -d web-server

  test:e2e:linux:
    desc: Run e2e tests on Linux
    cmds:
      - flutter drive
        --driver=test/02_integration/driver.dart
        --target=test/02_integration/server_list_e2e_test.dart
        -d linux

  test:all:
    desc: Run all tests
    cmds:
      - task: test:unit
      - task: test:widget
      - genhtml $(ls $(find . -name 'lcov.*.filtered.info')) -o coverage/html
      - echo "Coverage report generated at file://coverage/html/index.html"

  lint:
    desc: Run linter
    cmds:
      - flutter analyze
      - dart fix --dry-run

  lint:fix:
    desc: Fix lint errors
    cmds:
      - dart fix --apply

  format:
    desc: Format code
    cmds:
      - dart format .
  build:web:
    desc: Build for web
    cmds:
      - flutter build web --wasm

  build:linux:
    desc: Build debug linux executable
    deps:
      - setup
    cmds:
      - flutter build linux --release --target-sysroot ./bin/linux

  run:linux:
    desc: Build debug linux executable
    cmds:
      - flutter run -d linux

  run:web:
    desc: Run on web
    cmds:
      - flutter run -d chrome
